syntax = "proto3";

package game;

// P2P message wrapper for WebRTC communication
message P2PMessage {
  oneof payload {
    PlayerReady player_ready = 1;
    GameStart game_start = 2;
    FrameHash frame_hash = 3;
    SyncRequest sync_request = 4;
    SyncState sync_state = 5;
  }
}

// Player ready notification
message PlayerReady {
  string player_id = 1;
  string player_name = 2;
}

// Game start notification from host
message GameStart {
  uint64 seed = 1;
  repeated P2PPlayerInfo players = 2;
  bytes initial_state = 3;  // PhysicsSnapshot serialized
}

// Frame hash for determinism verification
message FrameHash {
  uint64 frame = 1;
  uint64 hash = 2;
}

// Request state sync from specific frame
message SyncRequest {
  uint64 from_frame = 1;
}

// State sync response
message SyncState {
  uint64 frame = 1;
  bytes state = 2;  // PhysicsSnapshot serialized
}

// Player info for P2P communication
message P2PPlayerInfo {
  string id = 1;
  string name = 2;
  uint32 color = 3;
}

// Game state snapshot
message GameState {
  uint64 frame = 1;
  repeated Marble marbles = 2;
  PhysicsState physics = 3;
}

// Marble entity
message Marble {
  uint32 id = 1;
  string owner_id = 2;
  Vector2 position = 3;
  Vector2 velocity = 4;
  float radius = 5;
  uint32 color = 6;
}

// Physics state for synchronization
message PhysicsState {
  bytes serialized_world = 1;
}

// 2D Vector
message Vector2 {
  float x = 1;
  float y = 2;
}

// Game input from player
message PlayerInput {
  uint64 frame = 1;
  string player_id = 2;
  InputAction action = 3;
}

// Possible input actions
message InputAction {
  oneof action {
    SpawnMarble spawn = 1;
    ApplyForce force = 2;
  }
}

message SpawnMarble {
  Vector2 position = 1;
  uint32 color = 2;
}

message ApplyForce {
  uint32 marble_id = 1;
  Vector2 force = 2;
}
