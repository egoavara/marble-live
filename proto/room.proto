syntax = "proto3";

package room;

// Room service for managing game sessions
service RoomService {
  // Create a new room
  rpc CreateRoom(CreateRoomRequest) returns (CreateRoomResponse);

  // Join an existing room
  rpc JoinRoom(JoinRoomRequest) returns (JoinRoomResponse);

  // Start the room
  rpc StartRoom(StartRoomRequest) returns (StartRoomResponse);

  // Start the game (spawn marbles) - host only, once per room
  rpc StartGame(StartGameRequest) returns (StartGameResponse);

  // Report player arrival (marble reached hole) - host only
  rpc ReportArrival(ReportArrivalRequest) returns (ReportArrivalResponse);

  // Kick a player from room
  rpc KickRoom(KickRoomRequest) returns (KickRoomResponse);

  // Get room info
  rpc GetRoom(GetRoomRequest) returns (GetRoomResponse);

  // Get room player info
  rpc GetRoomPlayer(GetRoomPlayerRequest) returns (GetRoomPlayerResponse);

  // Report connection status (periodic call from clients)
  rpc ReportConnection(ReportConnectionRequest) returns (ReportConnectionResponse);

  // Get topology info (for reconnection)
  rpc GetTopology(GetTopologyRequest) returns (GetTopologyResponse);

  // Register actual peer_id after P2P connection established
  rpc RegisterPeerId(RegisterPeerIdRequest) returns (RegisterPeerIdResponse);

  // Get all players' topologies in a room (requires auth)
  rpc GetRoomTopology(GetRoomTopologyRequest) returns (GetRoomTopologyResponse);

  // Resolve peer_ids to player_ids
  rpc ResolvePeerIds(ResolvePeerIdsRequest) returns (ResolvePeerIdsResponse);
}

message CreateRoomRequest {
  PlayerAuth host = 1;
  uint32 max_players = 2;
}

message CreateRoomResponse {
  string room_id = 1;
  string signaling_url = 2;
}

message JoinRoomRequest {
  string room_id = 1;
  PlayerAuth player = 2;
}

message JoinRoomResponse {
  string signaling_url = 1;
  PeerTopology topology = 2;  // Peer connection topology info
}

message StartRoomRequest {
  string room_id = 1;
  PlayerAuth player = 2;
}

message StartRoomResponse {
  string started_at = 1;
}

// Start game (spawn marbles) - can only be called once per room
message StartGameRequest {
  string room_id = 1;
  PlayerAuth player = 2;
  uint64 start_frame = 3;
  uint64 rng_seed = 4;
}

message StartGameResponse {
  bool success = 1;
  bool already_started = 2;
  string started_at = 3;
}

// Report player arrival (when marble reaches hole)
message ReportArrivalRequest {
  string room_id = 1;
  PlayerAuth player = 2;
  string arrived_player_id = 3;
  uint64 arrival_frame = 4;
  uint32 rank = 5;
}

message ReportArrivalResponse {
  bool success = 1;
  bool game_ended = 2;  // True when all players have arrived
}


message KickRoomRequest {
  string room_id = 1;
  PlayerAuth player = 2;
  string target_player = 3;
}

message KickRoomResponse {
}

message GetRoomRequest {
  string room_id = 1;
}

message GetRoomResponse {
  RoomInfo room = 1;
}

message GetRoomPlayerRequest {
  string room_id = 1;
}

message GetRoomPlayerResponse {
  repeated PlayerInfo players = 1;
}

message RoomInfo {
  string id = 1;
  uint32 max_players = 2;
  RoomState state = 3;
  string started_at = 4;

  // Network settings
  uint32 lockstep_delay_frames = 5;  // Lockstep delay frames
  uint32 gossip_ttl = 6;             // Gossip TTL (hop limit)
  uint32 mesh_group_size = 7;        // Mesh group size
  uint32 peer_connections = 8;       // Connections per peer (4~6)

  // Game state
  uint64 start_frame = 9;            // Frame when game started (spawn)
  uint64 rng_seed = 10;              // RNG seed used for game
  repeated PlayerResult results = 11; // Player arrival results
}

enum RoomState {
  UNDEFINED = 0;
  WAITING = 1;
  STARTED = 2;
  ENDED = 3;
}

message PlayerAuth {
  string id = 1;
  string secret = 2;
}

message PlayerInfo {
  string id = 1;
  bool is_host = 2;
  string display_id = 3;
}

// Player result (arrival info)
message PlayerResult {
  string player_id = 1;
  uint32 rank = 2;
  uint64 arrival_frame = 3;
}

// ========================================
// Topology related messages
// ========================================

// Peer connection info
message PeerConnection {
  string peer_id = 1;
  string player_id = 2;
}

// Peer topology info (included in JoinRoom response)
message PeerTopology {
  uint32 mesh_group = 1;                    // Group ID (0, 1, 2...)
  bool is_bridge = 2;                       // Is bridge node
  repeated PeerConnection connect_to = 3;   // Peers to connect (4~6)
  repeated PeerConnection bridge_peers = 4; // Bridge only: other group bridges
}

// Connection status report (client → server)
message ReportConnectionRequest {
  string room_id = 1;
  PlayerAuth player = 2;
  repeated PeerConnectionStatus peer_statuses = 3;
}

message PeerConnectionStatus {
  string peer_id = 1;
  uint32 rtt_ms = 2;           // RTT in milliseconds
  float packet_loss = 3;       // Packet loss rate (0.0~1.0)
  bool connected = 4;          // Connection status
}

message ReportConnectionResponse {
  bool topology_changed = 1;              // Topology changed flag
  optional PeerTopology new_topology = 2; // New topology if changed
}

// Get topology request (for reconnection)
message GetTopologyRequest {
  string room_id = 1;
  PlayerAuth player = 2;
}

message GetTopologyResponse {
  PeerTopology topology = 1;
}

// Register peer_id request (client → server after P2P connection)
message RegisterPeerIdRequest {
  string room_id = 1;
  PlayerAuth player = 2;
  string peer_id = 3;
}

message RegisterPeerIdResponse {
  bool success = 1;
  optional PeerTopology updated_topology = 2;
}

// Get room topology request (requires auth - only room members can view)
message GetRoomTopologyRequest {
  string room_id = 1;
  PlayerAuth player_auth = 2;  // Authentication required
}

// Per-player topology info
message PlayerTopologyInfo {
  string player_id = 1;
  PeerTopology topology = 2;  // Reuse existing PeerTopology
  bool is_connected = 3;      // Current connection status
}

// Get room topology response
message GetRoomTopologyResponse {
  repeated PlayerTopologyInfo players = 1;
}

// Resolve peer_ids to player_ids request
message ResolvePeerIdsRequest {
  string room_id = 1;
  PlayerAuth player = 2;
  repeated string peer_ids = 3;
}

// Resolve peer_ids to player_ids response
message ResolvePeerIdsResponse {
  map<string, string> peer_to_player = 1;  // peer_id → player_id
}